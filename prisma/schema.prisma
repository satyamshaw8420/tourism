// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  name      String
  avatar    String?
  phone     String?
  password  String
  kycStatus KycStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  groupMembers  GroupMember[]
  transactions  Transaction[]
  emiPlans      EMIPlan[]
  bookings      Booking[]
  groups        Group[]       @relation("GroupCreator")
  itineraries   CustomItinerary[]
  votes         ItineraryVote[]

  @@map("users")
}

model Destination {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  image       String
  category    DestinationCategory
  location    DestinationLocation
  rating      Float             @default(0)
  reviewCount Int               @default(0)
  featured    Boolean           @default(false)
  createdAt   DateTime          @default(now())

  // Relations
  tours TourPackage[]

  @@map("destinations")
}

model TourPackage {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  description  String
  images       String[]
  destinationId String        @db.ObjectId
  duration     Int            // in days
  price        Float
  originalPrice Float?
  maxGroupSize Int
  minGroupSize Int
  inclusions   String[]
  exclusions   String[]
  itinerary    ItineraryDay[]
  availability DateTime[]
  rating       Float          @default(0)
  reviewCount  Int            @default(0)
  featured     Boolean        @default(false)
  createdAt    DateTime       @default(now())

  // Relations
  destination Destination @relation(fields: [destinationId], references: [id])
  bookings    Booking[]
  groups      Group[]

  @@map("tours")
}

model Group {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  description  String
  creatorId    String        @db.ObjectId
  tourId       String?       @db.ObjectId
  status       GroupStatus   @default(PLANNING)
  maxMembers   Int
  isPublic     Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  creator          User              @relation("GroupCreator", fields: [creatorId], references: [id])
  tour             TourPackage?      @relation(fields: [tourId], references: [id])
  members          GroupMember[]
  wallet           GroupWallet?
  customItinerary  CustomItinerary[]
  transactions     Transaction[]

  @@map("groups")
}

model GroupMember {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  userId       String       @db.ObjectId
  groupId      String       @db.ObjectId
  role         MemberRole   @default(MEMBER)
  contribution Float        @default(0)
  joinedAt     DateTime     @default(now())
  status       MemberStatus @default(PENDING)

  // Relations
  user  User  @relation(fields: [userId], references: [id])
  group Group @relation(fields: [groupId], references: [id])

  @@unique([userId, groupId])
  @@map("group_members")
}

model GroupWallet {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  groupId      String   @unique @db.ObjectId
  balance      Float    @default(0)
  targetAmount Float
  createdAt    DateTime @default(now())

  // Relations
  group        Group         @relation(fields: [groupId], references: [id])
  transactions Transaction[]
  emiPlans     EMIPlan[]

  @@map("group_wallets")
}

model Transaction {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  amount        Float
  type          TransactionType
  description   String
  userId        String            @db.ObjectId
  groupId       String?           @db.ObjectId
  walletId      String?           @db.ObjectId
  status        TransactionStatus @default(PENDING)
  paymentMethod PaymentMethod
  razorpayId    String?
  createdAt     DateTime          @default(now())

  // Relations
  user   User         @relation(fields: [userId], references: [id])
  group  Group?       @relation(fields: [groupId], references: [id])
  wallet GroupWallet? @relation(fields: [walletId], references: [id])

  @@map("transactions")
}

model EMIPlan {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  userId          String       @db.ObjectId
  walletId        String?      @db.ObjectId
  amount          Float
  duration        Int          // months
  interestRate    Float
  monthlyAmount   Float
  remainingAmount Float
  status          EMIStatus    @default(ACTIVE)
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime     @default(now())

  // Relations
  user     User         @relation(fields: [userId], references: [id])
  wallet   GroupWallet? @relation(fields: [walletId], references: [id])
  payments EMIPayment[]

  @@map("emi_plans")
}

model EMIPayment {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  planId    String          @db.ObjectId
  amount    Float
  dueDate   DateTime
  paidAt    DateTime?
  status    EMIPaymentStatus @default(PENDING)
  createdAt DateTime        @default(now())

  // Relations
  plan EMIPlan @relation(fields: [planId], references: [id])

  @@map("emi_payments")
}

model Booking {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  userId         String         @db.ObjectId
  tourId         String         @db.ObjectId
  groupId        String?        @db.ObjectId
  travelers      Traveler[]
  totalAmount    Float
  paidAmount     Float          @default(0)
  paymentStatus  PaymentStatus  @default(PENDING)
  bookingStatus  BookingStatus  @default(PENDING)
  specialRequests String?
  travelDate     DateTime
  createdAt      DateTime       @default(now())

  // Relations
  user User        @relation(fields: [userId], references: [id])
  tour TourPackage @relation(fields: [tourId], references: [id])

  @@map("bookings")
}

model CustomItinerary {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  days        CustomItineraryDay[]
  totalBudget Float
  createdById String      @db.ObjectId
  groupId     String      @db.ObjectId
  status      ItineraryStatus @default(DRAFT)
  createdAt   DateTime    @default(now())

  // Relations
  createdBy User            @relation(fields: [createdById], references: [id])
  group     Group           @relation(fields: [groupId], references: [id])
  votes     ItineraryVote[]

  @@map("custom_itineraries")
}

model ItineraryVote {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  userId       String     @db.ObjectId
  itineraryId  String     @db.ObjectId
  vote         VoteType
  comment      String?
  createdAt    DateTime   @default(now())

  // Relations
  user      User            @relation(fields: [userId], references: [id])
  itinerary CustomItinerary @relation(fields: [itineraryId], references: [id])

  @@unique([userId, itineraryId])
  @@map("itinerary_votes")
}

// Embedded Types
type DestinationLocation {
  lat     Float
  lng     Float
  address String
}

type ItineraryDay {
  day           Int
  title         String
  description   String
  activities    String[]
  meals         String[]
  accommodation String?
}

type CustomItineraryDay {
  day           Int
  date          DateTime
  location      String
  activities    Activity[]
  accommodation Accommodation?
  budget        Float
}

type Activity {
  id          String
  name        String
  type        String
  duration    Int    // hours
  cost        Float
  description String
  location    String
  timeSlot    String
}

type Accommodation {
  name         String
  type         String
  rating       Float
  pricePerNight Float
  location     String
}

type Traveler {
  name     String
  age      Int
  gender   String
  idType   String
  idNumber String
}

// Enums
enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum DestinationCategory {
  BEACH
  MOUNTAIN
  HERITAGE
  ADVENTURE
  CITY
}

enum GroupStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum MemberRole {
  ADMIN
  MEMBER
}

enum MemberStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentMethod {
  UPI
  CARD
  WALLET
  EMI
}

enum EMIStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
}

enum EMIPaymentStatus {
  PENDING
  PAID
  OVERDUE
}

enum PaymentStatus {
  PENDING
  PARTIAL
  COMPLETED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum ItineraryStatus {
  DRAFT
  FINALIZED
}

enum VoteType {
  APPROVE
  REJECT
  SUGGEST_CHANGES
}